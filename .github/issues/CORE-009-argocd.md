# CORE-009: ArgoCD

## Component Requirements

**Component**: ArgoCD  
**Type**: Core  
**Priority**: High  
**Dependencies**: Keycloak, MicroK8s  

## Description

Migrate ArgoCD deployment from thinkube-core to thinkube. ArgoCD is the GitOps continuous delivery tool for Kubernetes and is critical for managing application deployments.

## Requirements Analysis

Based on source playbooks analysis:

### Deployment Requirements
1. **Namespace**: `argocd`
2. **Helm Chart**: 
   - Repository: `https://argoproj.github.io/argo-helm`
   - Chart: `argo-cd`
3. **Ingress Configuration**:
   - Primary domain: `{{ argocd_hostname }}`
   - gRPC domain: `{{ argocd_grpc_hostname }}`
   - TLS certificate requirements
4. **Authentication**: 
   - OIDC integration with Keycloak
   - Client ID: `argocd`
   - Redirect URIs properly configured
5. **CLI Tools**:
   - ArgoCD CLI version v2.13.1
   - Installation to `/usr/local/bin/argocd`

### Keycloak Integration
1. **Client Configuration**:
   - Client ID: `argocd`
   - Protocol: `openid-connect`
   - Standard flow enabled
   - Redirect URIs for both API and UI access
   - Web origins configured
2. **Protocol Mappers**:
   - Group membership mapper required
   - Client roles mapper
   - Audience mappers
3. **Secret Retrieval**:
   - Client secret must be obtained from Keycloak
   - Used for OIDC configuration in Helm values

### Access Control
1. **Service Account**:
   - Deployment service account configuration
   - Token generation for CI/CD integration
2. **SSH Keys**:
   - GitHub SSH key configuration
   - Secret management for repository access
3. **Admin Credentials**:
   - Initial admin secret retrieval
   - Credential storage in `.env` file

### Configuration Components
1. **Helm Values**:
   - Server configuration with OIDC settings
   - Dex integration for authentication
   - Redis configuration
   - Repository server settings
   - Controller configuration
2. **Ingress Settings**:
   - Class: custom-nginx
   - TLS configuration with wildcard certificates
   - gRPC support via separate ingress
3. **RBAC Policies**:
   - Admin group mapping from Keycloak
   - Policy enforcement configuration

## Migration Plan

### Phase 1: Infrastructure Setup
1. Create namespace structure: `ansible/40_thinkube/core/argocd/10_namespace.yaml`
2. Configure Keycloak client: `ansible/40_thinkube/core/argocd/20_keycloak_client.yaml`
3. Deploy ArgoCD via Helm: `ansible/40_thinkube/core/argocd/30_deploy_argocd.yaml`

### Phase 2: Configuration
1. Configure service accounts: `ansible/40_thinkube/core/argocd/40_service_account.yaml`
2. Setup CLI and credentials: `ansible/40_thinkube/core/argocd/50_cli_setup.yaml`
3. Configure repository access: `ansible/40_thinkube/core/argocd/60_repository_config.yaml`

### Phase 3: Testing
1. Validate OIDC login: `ansible/40_thinkube/core/argocd/88_test_argocd.yaml`
2. Test repository connectivity
3. Verify admin access
4. Test CLI functionality

### Phase 4: Rollback
1. Create rollback playbook: `ansible/40_thinkube/core/argocd/89_rollback_argocd.yaml`

## Implementation Checklist

- [ ] Create directory structure under `ansible/40_thinkube/core/argocd/`
- [ ] Migrate namespace creation logic
- [ ] Port Keycloak client configuration with updated variables
- [ ] Convert Helm deployment to use component structure
- [ ] Implement service account configuration
- [ ] Setup CLI installation and configuration
- [ ] Configure repository access and SSH keys
- [ ] Create comprehensive test playbook
- [ ] Implement rollback procedures
- [ ] Update documentation

## Notes

- Source playbooks use multiple steps for comprehensive setup
- Keycloak integration must be completed before ArgoCD deployment
- Service account configuration is critical for GitOps workflows
- CLI installation enables developer access and automation
- The deployment includes both UI and API/gRPC access points

## Related Files

**Source Playbooks**:
- `services/80r_setup_argocd_keycloak.yaml` - Keycloak client setup
- `services/81_setup_argocd.yaml` - Main ArgoCD deployment
- `services/82_get_argocd_credentials.yaml` - Credential retrieval
- `services/83_setup_argocd_serviceaccount.yaml` - Service account and CLI setup

**Target Directory**: `ansible/40_thinkube/core/argocd/`

---
*Migration tracking for Thinkube platform - Generated by Analysis System*