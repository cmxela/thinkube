# OPT-001: Prometheus

## Component Requirements

**Component**: Prometheus  
**Type**: Optional  
**Priority**: Medium  
**Dependencies**: MicroK8s, TLS Certificates  

## Description

Migrate Prometheus deployment from thinkube-core to thinkube. Prometheus is the metrics collection and monitoring system used for gathering cluster and application metrics.

## Requirements Analysis

Based on source playbook analysis:

### Deployment Requirements
1. **Namespace**: `monitoring`
2. **Deployment Method**: 
   - StatefulSet with persistent storage
   - Direct Kubernetes manifests
3. **Storage**:
   - Persistent Volume: 20Gi
   - Storage class: `microk8s-hostpath`
4. **Container Image**:
   - Registry: `registry.cmxela.com/library/prometheus:latest`
   - Mirrored from official image

### RBAC Configuration
1. **Service Account**: `prometheus`
2. **ClusterRole**: Full cluster access for metrics
3. **ClusterRoleBinding**: Links role to service account
4. **Permissions**:
   - Get, list, watch on nodes, services, endpoints, pods
   - Non-resource URLs for metrics paths

### Configuration Management
1. **ConfigMap**: Prometheus configuration
2. **Scrape Configs**:
   - Kubernetes API server
   - Node metrics
   - Pod metrics
   - Service endpoints
3. **Service Discovery**:
   - Kubernetes SD configuration
   - Label-based filtering

### Networking
1. **Service**: ClusterIP service
2. **Ingress**:
   - Hostname: `{{ prometheus_hostname }}`
   - TLS termination
   - Ingress class configuration
3. **TLS Secret**:
   - Certificate and key paths
   - Secret name: `prometheus-tls-secret`

### Authentication
1. **No OAuth2 Proxy**: Direct access (from source analysis)
2. **Consider adding**: Keycloak integration for production
3. **Access Control**: Currently relies on network-level security

## Migration Plan

### Phase 1: Infrastructure Setup
1. Create namespace and RBAC: `ansible/40_thinkube/optional/prometheus/10_namespace_rbac.yaml`
2. Configure service account: `ansible/40_thinkube/optional/prometheus/15_service_account.yaml`

### Phase 2: Configuration
1. Create ConfigMap: `ansible/40_thinkube/optional/prometheus/20_configmap.yaml`
2. Configure scrape targets: `ansible/40_thinkube/optional/prometheus/25_scrape_config.yaml`

### Phase 3: Deployment
1. Deploy StatefulSet: `ansible/40_thinkube/optional/prometheus/30_statefulset.yaml`
2. Create Service: `ansible/40_thinkube/optional/prometheus/40_service.yaml`
3. Configure Ingress: `ansible/40_thinkube/optional/prometheus/50_ingress.yaml`

### Phase 4: Optional Security
1. Add OAuth2 Proxy: `ansible/40_thinkube/optional/prometheus/60_oauth2_proxy.yaml`
2. Configure Keycloak client: `ansible/40_thinkube/optional/prometheus/65_keycloak_client.yaml`

### Phase 5: Testing
1. Validate metrics collection: `ansible/40_thinkube/optional/prometheus/88_test_prometheus.yaml`
2. Test service discovery
3. Verify data persistence
4. Check ingress access

### Phase 6: Rollback
1. Create rollback playbook: `ansible/40_thinkube/optional/prometheus/89_rollback_prometheus.yaml`

## Implementation Checklist

- [ ] Create directory structure under `ansible/40_thinkube/optional/prometheus/`
- [ ] Migrate namespace and RBAC configuration
- [ ] Port service account and cluster roles
- [ ] Configure Prometheus ConfigMap
- [ ] Setup StatefulSet with persistent storage
- [ ] Create Service and Ingress
- [ ] Configure TLS certificates
- [ ] Optionally add OAuth2 Proxy for security
- [ ] Create comprehensive test playbook
- [ ] Implement rollback procedures
- [ ] Update documentation

## Notes

- Source playbook does not include OAuth2 Proxy
- Consider adding Keycloak integration for production use
- StatefulSet ensures data persistence across restarts
- Storage class must be available in the cluster
- Metrics collection requires cluster-wide permissions
- Image is mirrored to local registry

## Related Files

**Source Playbook**: `services/90_setup_prometheus.yaml`  
**Target Directory**: `ansible/40_thinkube/optional/prometheus/`

**Key Resources**:
- ServiceAccount with cluster-wide permissions
- ClusterRole for metrics access
- StatefulSet with persistent storage
- ConfigMap for Prometheus configuration
- Ingress with TLS termination

---
*Migration tracking for Thinkube platform - Generated by Analysis System*