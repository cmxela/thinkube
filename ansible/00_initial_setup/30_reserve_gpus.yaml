---
# 30_reserve_gpus.yaml - Reserve GPUs for later passthrough to VMs
#
# Purpose:
#   Configures a host system to keep one GPU for the host OS
#   while reserving others for future passthrough configuration
#
# Requirements:
#   - Host system should have multiple GPUs for this to be useful
#   - If only one GPU is present, it will be kept for the host with no passthrough
#
# Variables:
#   - host_gpu_type: GPU type to keep for host ('intel', 'amd', 'nvidia')
#   - host_gpu_index: If multiple of the same type, which one to keep (0-based)
#   - server_type: 'desktop' or 'headless' (determines X.org config needs)
#
# Run with:
#   ansible-playbook -i inventory/inventory.yaml ansible/00_initial_setup/30_reserve_gpus.yaml -e "ansible_become_pass=$ANSIBLE_SUDO_PASS"
#
# This should be the first playbook executed in systems with multiple GPUs

- name: Reserve GPUs for Later Passthrough
  hosts: baremetal
  become: true
  gather_facts: true
  
  vars:
    # Default values that can be overridden in inventory
    host_gpu_type: "amd"  # Which GPU to keep for host: 'intel', 'amd', 'nvidia'
    host_gpu_index: 0     # If multiple of same type, which one to keep (0-based)
    
  tasks:
    - name: Display setup information
      ansible.builtin.debug:
        msg: >-
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ”§ Reserving GPUs for Passthrough ({{ inventory_hostname }})
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          This playbook will configure the system to reserve GPUs
          for future passthrough while keeping one GPU for the host OS.
          
          Host OS will use: {{ host_gpu_type }} GPU (index {{ host_gpu_index }})
          All other GPUs will be reserved for passthrough.
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    # Phase 1: Detect all GPUs in the system
    - name: Detect all GPUs
      ansible.builtin.shell: |
        lspci -nnk | grep -A3 "VGA\|3D\|Display" | grep -v "Kernel driver in use" | grep -v "Kernel modules"
      register: gpu_list
      changed_when: false
      
    - name: Parse GPU list
      ansible.builtin.set_fact:
        detected_gpus: "{{ gpu_list.stdout_lines }}"
        
    - name: Display detected GPUs
      ansible.builtin.debug:
        msg: "Detected GPUs: {{ detected_gpus }}"
    
    # Phase 2: Identify GPU types and assign host/passthrough roles
    - name: Identify GPU types
      ansible.builtin.set_fact:
        nvidia_gpus: "{{ detected_gpus | select('search', 'NVIDIA') | list }}"
        amd_gpus: "{{ detected_gpus | select('search', 'AMD') | list }}"
        intel_gpus: "{{ detected_gpus | select('search', 'Intel') | list }}"
    
    - name: Display GPU counts by type
      ansible.builtin.debug:
        msg: |
          GPU Count by Type:
          - NVIDIA: {{ nvidia_gpus | length }}
          - AMD: {{ amd_gpus | length }}
          - Intel: {{ intel_gpus | length }}
    
    # Determine if passthrough makes sense based on the server type
    - name: Calculate total GPUs
      ansible.builtin.set_fact:
        total_gpus: "{{ nvidia_gpus | length + amd_gpus | length + intel_gpus | length }}"
    
    # Debug server_type variable
    - name: Debug server_type
      ansible.builtin.debug:
        msg: "Server type for {{ inventory_hostname }}: {{ server_type | default('undefined') }}"
        verbosity: 1
    
    # For desktop systems, require at least 2 GPUs (one for host, one for passthrough)
    # For headless systems, allow single GPU passthrough (we need a special flag for this case)
    - name: Determine if GPU passthrough is safe for this system
      ansible.builtin.set_fact:
        can_configure_passthrough: "{{ (total_gpus | int >= 2) or (server_type is defined and server_type == 'headless' and total_gpus | int == 1) }}"
        single_gpu_passthrough: "{{ server_type is defined and server_type == 'headless' and total_gpus | int == 1 }}"
    
    - name: Display warning if skipping configuration
      ansible.builtin.debug:
        msg: |
          WARNING: Only one GPU detected on a desktop system. Skipping passthrough configuration
          to prevent rendering the system unusable. For headless servers, a single GPU can be
          used for passthrough.
      when: not can_configure_passthrough | bool and (server_type is defined and server_type == 'desktop' and total_gpus | int < 2)
      
    - name: Display single GPU passthrough on headless server
      ansible.builtin.debug:
        msg: |
          NOTE: Single GPU detected on headless server {{ inventory_hostname }}. 
          This GPU will be configured for passthrough since display capabilities 
          are not needed on a headless server accessed via SSH.
      when: can_configure_passthrough | bool and total_gpus | int == 1 and server_type is defined and server_type == 'headless'
    
    - name: Select GPUs for passthrough
      ansible.builtin.set_fact:
        passthrough_gpus: "{% if single_gpu_passthrough | bool %}{{ nvidia_gpus + amd_gpus + intel_gpus }}{% elif host_gpu_type == 'nvidia' %}{{ nvidia_gpus[:host_gpu_index] + nvidia_gpus[(host_gpu_index + 1):] + amd_gpus + intel_gpus }}{% elif host_gpu_type == 'amd' %}{{ amd_gpus[:host_gpu_index] + amd_gpus[(host_gpu_index + 1):] + nvidia_gpus + intel_gpus }}{% elif host_gpu_type == 'intel' %}{{ intel_gpus[:host_gpu_index] + intel_gpus[(host_gpu_index + 1):] + nvidia_gpus + amd_gpus }}{% endif %}"
      when: can_configure_passthrough
      
    - name: Select Host GPU
      ansible.builtin.set_fact:
        host_gpu: >-
          {% if single_gpu_passthrough | bool %}
            ""
          {% elif host_gpu_type == 'nvidia' and nvidia_gpus | length > host_gpu_index %}
            {{ nvidia_gpus[host_gpu_index] }}
          {% elif host_gpu_type == 'amd' and amd_gpus | length > host_gpu_index %}
            {{ amd_gpus[host_gpu_index] }}
          {% elif host_gpu_type == 'intel' and intel_gpus | length > host_gpu_index %}
            {{ intel_gpus[host_gpu_index] }}
          {% else %}
            {% if nvidia_gpus | length > 0 %}
              {{ nvidia_gpus[0] }}
            {% elif amd_gpus | length > 0 %}
              {{ amd_gpus[0] }}
            {% elif intel_gpus | length > 0 %}
              {{ intel_gpus[0] }}
            {% else %}
              ""
            {% endif %}
          {% endif %}
      when: can_configure_passthrough
    
    - name: Display host GPU
      ansible.builtin.debug:
        msg: "Host GPU: {{ host_gpu }}"
      when: can_configure_passthrough and host_gpu is defined
    
    # Extract host GPU PCI ID to exclude it from passthrough
    - name: Extract host GPU PCI ID
      ansible.builtin.set_fact:
        host_gpu_pci_id: "{{ host_gpu | regex_findall('\\[[0-9a-f]{4}:[0-9a-f]{4}\\]') | first | regex_replace('\\[([0-9a-f]{4}:[0-9a-f]{4})\\]', '\\1') }}"
      when: can_configure_passthrough and host_gpu is defined and host_gpu is search('\\[[0-9a-f]{4}:[0-9a-f]{4}\\]')
      
    # Check for assigned PCI slots in inventory
    - name: Check if PCI slots are explicitly assigned in inventory
      ansible.builtin.set_fact:
        assigned_pci_slots: "{{ assigned_pci_slots | default([]) + [item.value.pci_slot | lower] }}"
      loop: "{{ lookup('dict', hostvars) }}"
      when: >
        item.value.gpu_passthrough is defined and 
        item.value.gpu_passthrough | bool and 
        item.value.parent_host is defined and 
        item.value.parent_host == inventory_hostname and 
        item.value.pci_slot is defined and 
        item.value.pci_slot | trim != ''
    
    - name: Display assigned PCI slots from inventory
      ansible.builtin.debug:
        msg: |
          PCI slots explicitly assigned for passthrough:
          {{ assigned_pci_slots | default([]) | join(', ') }}
      when: assigned_pci_slots is defined
    
    # Extract PCI IDs for passthrough GPUs based on assigned PCI slots
    - name: Extract PCI IDs for assigned GPUs
      ansible.builtin.set_fact:
        gpu_pci_ids: "{{ gpu_pci_ids | default([]) + [detected_id] }}"
      vars:
        pci_slot: "{{ item | regex_search('^[0-9a-f]{2}:[0-9a-f]{2}\\.[0-9a-f]') | default('') }}"
        detected_id: "{{ item | regex_findall('\\[[0-9a-f]{4}:[0-9a-f]{4}\\]') | first | regex_replace('\\[([0-9a-f]{4}:[0-9a-f]{4})\\]', '\\1') }}"
      loop: "{{ nvidia_gpus + amd_gpus + intel_gpus }}"
      when: >
        assigned_pci_slots is defined and
        assigned_pci_slots | length > 0 and
        item is regex('\\[[0-9a-f]{4}:[0-9a-f]{4}\\]') and
        (pci_slot | lower in assigned_pci_slots or
         pci_slot | replace('.', ':') | lower in assigned_pci_slots)
        
    # Fallback: Extract PCI IDs for passthrough GPUs if no assigned slots
    - name: Extract PCI IDs for GPUs (fallback method)
      ansible.builtin.set_fact:
        gpu_pci_ids: "{{ gpu_pci_ids | default([]) + [detected_id] }}"
      vars:
        detected_id: "{{ item | regex_findall('\\[[0-9a-f]{4}:[0-9a-f]{4}\\]') | first | regex_replace('\\[([0-9a-f]{4}:[0-9a-f]{4})\\]', '\\1') }}"
      loop: "{{ nvidia_gpus + amd_gpus + intel_gpus }}"
      when: >
        (assigned_pci_slots is not defined or assigned_pci_slots | length == 0) and
        item is regex('\\[[0-9a-f]{4}:[0-9a-f]{4}\\]') and 
        (host_gpu is not defined or item != host_gpu)
        
    # Use a simpler approach for now - find NVIDIA audio devices directly
    - name: Get associated audio devices for GPUs
      ansible.builtin.shell: |
        # Find all NVIDIA audio devices
        lspci -n | grep "10de" | grep "0403" | awk '{print $3}' | tr -d .
      register: audio_devices_result
      changed_when: false
      when: can_configure_passthrough and (gpu_pci_ids is defined and gpu_pci_ids | length > 0)
      
    # Add audio device IDs to the PCI IDs for passthrough
    - name: Add audio device IDs to passthrough list
      ansible.builtin.set_fact:
        gpu_pci_ids: "{{ gpu_pci_ids + audio_devices_result.stdout_lines }}"
      when: can_configure_passthrough and (audio_devices_result is defined and audio_devices_result.stdout != "")
      
    # Use a more direct approach for IOMMU group detection but only for GPUs in assigned slots
    - name: Find all devices in the same IOMMU groups as assigned GPUs
      ansible.builtin.shell: |
        # Get GPU PCI slots from assigned slots in inventory
        {% if assigned_pci_slots is defined and assigned_pci_slots|length > 0 %}
        gpu_slots="{{ assigned_pci_slots | join(' ') | replace(':', '\:') }}"
        for gpu in $gpu_slots; do
          # Find IOMMU group
          for group_dir in /sys/kernel/iommu_groups/*/devices/0000:$gpu; do
            if [ -e "$group_dir" ]; then
              group=$(echo $group_dir | cut -d/ -f5)
              echo "IOMMU Group $group for GPU $gpu:"
              # List all devices in this group by vendor:device ID
              for dev in /sys/kernel/iommu_groups/$group/devices/*; do
                dev_addr=$(basename $dev)
                vendor_device=$(lspci -n -s $dev_addr | awk '{print $3}')
                if [ -n "$vendor_device" ]; then
                  echo "$vendor_device"
                fi
              done
            fi
          done
        done
        {% else %}
        # Fallback to all NVIDIA GPUs if no assigned slots
        gpu_slots=$(lspci | grep "VGA.*NVIDIA" | awk '{print $1}')
        
        # Find which IOMMU groups these GPUs belong to
        for gpu in $gpu_slots; do
          # Find IOMMU group
          for group_dir in /sys/kernel/iommu_groups/*/devices/0000:$gpu; do
            if [ -e "$group_dir" ]; then
              group=$(echo $group_dir | cut -d/ -f5)
              echo "IOMMU Group $group for GPU $gpu:"
              # List all devices in this group by vendor:device ID
              for dev in /sys/kernel/iommu_groups/$group/devices/*; do
                dev_addr=$(basename $dev)
                vendor_device=$(lspci -n -s $dev_addr | awk '{print $3}')
                if [ -n "$vendor_device" ]; then
                  echo "$vendor_device"
                fi
              done
            fi
          done
        done
        {% endif %}
        
        # Show PCI slot format for reference
        echo "\nCurrent GPU PCI slots:"
        lspci | grep -E "VGA|3D|Display"
      register: iommu_devices_result
      changed_when: false
      when: can_configure_passthrough and (gpu_pci_ids is defined and gpu_pci_ids | length > 0)
      
    # Add IOMMU devices to passthrough list but exclude host GPU
    - name: Add IOMMU devices to passthrough list
      ansible.builtin.set_fact:
        gpu_pci_ids: "{{ ((gpu_pci_ids + iommu_devices_result.stdout_lines | select('match', '^[0-9a-f]{4}:[0-9a-f]{4}$') | list) | unique | reject('equalto', host_gpu_pci_id) | list) }}"
      when: can_configure_passthrough and (iommu_devices_result is defined and iommu_devices_result.stdout != "") and host_gpu_pci_id is defined
      
    # Display complete list of PCI IDs for VFIO binding
    - name: Display complete list of PCI IDs for VFIO binding
      ansible.builtin.debug:
        msg: |
          Complete list of PCI IDs for VFIO binding:
          {{ gpu_pci_ids | sort | join(', ') }}
          
          This includes GPUs, audio controllers, and all other devices in the same IOMMU groups.
          Host GPU PCI ID (excluded from VFIO binding): {{ host_gpu_pci_id | default('None') }}
      when: can_configure_passthrough and (gpu_pci_ids is defined and gpu_pci_ids | length > 0)
    
    # Handle multiple GPU case
    # The previous task now handles all PCI ID extraction
      
    # Extract the BusID from host_gpu if it matches the pattern
    - name: Extract GPU BusID for X.org
      ansible.builtin.shell: |
        {% if host_gpu is defined and host_gpu|string is match("^[0-9a-f]{2}:[0-9a-f]{2}\\.[0-9a-f]") %}
        echo "{{ host_gpu|string }}" | grep -oE "^[0-9a-f]{2}:[0-9a-f]{2}\.[0-9a-f]"
        {% else %}
        echo ""
        {% endif %}
      register: gpu_busid_raw
      changed_when: false
      when: can_configure_passthrough and host_gpu is defined and host_gpu|string != ""
      
    # Format the BusID for X.org if it was successfully extracted
    - name: Format BusID for X.org
      ansible.builtin.set_fact:
        xorg_busid: "PCI:{{ busid_parts[0]|int }}:{{ busid_parts[1]|int }}:{{ busid_parts[2]|int }}"
      vars:
        busid: "{{ gpu_busid_raw.stdout|default('') }}"
        busid_parts:
          - "{{ busid.split(':')[0]|default('0')|replace('0', '')|int|default(0) }}"
          - "{{ busid.split(':')[1].split('.')[0]|default('0')|int|default(0) if ':' in busid else 0 }}"
          - "{{ busid.split(':')[1].split('.')[1]|default('0')|int|default(0) if ':' in busid and '.' in busid.split(':')[1] else 0 }}"
      when: can_configure_passthrough and gpu_busid_raw is defined and gpu_busid_raw.stdout|default('')|trim != ""
      
    - name: Display GPUs for passthrough
      ansible.builtin.debug:
        msg: |
          GPUs selected for passthrough:
          {% if assigned_pci_slots is defined and assigned_pci_slots|length > 0 %}
          Only GPUs explicitly assigned in inventory:
          {{ assigned_pci_slots | join(', ') }}
          {% elif passthrough_gpus is defined %}
          {{ passthrough_gpus | join('\n') }}
          {% else %}
          All GPUs
          {% endif %}
          
          PCI IDs for VFIO:
          {{ gpu_pci_ids | join(', ') }}
      when: can_configure_passthrough and gpu_pci_ids is defined and gpu_pci_ids | length > 0
    
    # Phase 3: Enable IOMMU in GRUB
    - name: Detect CPU vendor (needed for all cases)
      ansible.builtin.set_fact:
        is_amd_cpu: "{{ ansible_processor[0] is regex('AMD') }}"
    
    - name: Enable IOMMU in GRUB
      ansible.builtin.replace:
        path: /etc/default/grub
        regexp: '^(GRUB_CMDLINE_LINUX_DEFAULT=")(.*)(")'
        replace: '\1\2 {{ "amd_iommu=on" if is_amd_cpu else "intel_iommu=on" }} iommu=pt\3'
        backup: yes
      register: grub_updated
    
    # Phase 4: Configure VFIO modules
    # For hosts with specifically assigned PCI slots, create a base VFIO configuration
    - name: Create VFIO configuration - general settings
      ansible.builtin.copy:
        dest: /etc/modprobe.d/vfio.conf
        content: |
          # Basic VFIO configuration
          options vfio-pci disable_vga=1
        mode: '0644'
      when: can_configure_passthrough
      
    # Create dedicated binding scripts for specific PCI slots
    - name: Create dedicated VFIO binding script for each slot
      ansible.builtin.template:
        src: templates/vfio-bind.sh.j2
        dest: "/usr/local/bin/vfio-bind-{{ item | replace(':', '-') }}.sh"
        mode: '0755'
        owner: root
        group: root
      loop: "{{ assigned_pci_slots | default([]) }}"
      vars:
        pci_slot: "{{ item }}"
      when: >
        assigned_pci_slots is defined and
        assigned_pci_slots | length > 0

    # Create systemd service to run the binding script at boot
    - name: Create systemd service for VFIO binding
      ansible.builtin.template:
        src: templates/vfio-bind.service.j2
        dest: "/etc/systemd/system/vfio-bind-{{ item | replace(':', '-') }}.service"
        mode: '0644'
      vars:
        pci_slot: "{{ item }}"
      loop: "{{ assigned_pci_slots | default([]) }}"
      when: >
        assigned_pci_slots is defined and
        assigned_pci_slots | length > 0
        
    # Enable the systemd service
    - name: Enable VFIO binding service
      ansible.builtin.systemd:
        name: "vfio-bind-{{ item | replace(':', '-') }}.service"
        enabled: yes
        daemon_reload: yes
      loop: "{{ assigned_pci_slots | default([]) }}"
      when: >
        assigned_pci_slots is defined and
        assigned_pci_slots | length > 0
    
    # Standard configuration for other hosts without specific slot assignments
    - name: Create VFIO configuration - standard
      ansible.builtin.copy:
        dest: /etc/modprobe.d/vfio.conf
        content: |
          # Standard VFIO configuration by vendor:device ID
          options vfio-pci ids={{ gpu_pci_ids | join(',') }}
        mode: '0644'
      when: >
        (assigned_pci_slots is not defined or assigned_pci_slots | length == 0) and
        gpu_pci_ids is defined and 
        gpu_pci_ids | length > 0
    
    - name: Ensure VFIO modules are loaded early
      ansible.builtin.lineinfile:
        path: /etc/initramfs-tools/modules
        line: "{{ item }}"
        create: yes
      loop:
        - "vfio"
        - "vfio_iommu_type1"
        - "vfio_pci"
        - "vfio_virqfd"
    
    # Phase 5: Configure GPU drivers for passthrough devices
    # Only blacklist nouveau (for all systems)
    - name: Only blacklist nouveau driver
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-nouveau.conf
        content: |
          # Only blacklist the open source nvidia driver (nouveau)
          # to allow NVIDIA proprietary driver to load
          blacklist nouveau
        mode: '0644'
      when: nvidia_gpus | length > 0
      
    # Add vfio-pci driver options to control driver binding
    - name: Configure VFIO binding priority
      ansible.builtin.copy:
        dest: /etc/modprobe.d/nvidia-vfio.conf
        content: |
          # Set VFIO to load first, so it can claim devices based on configuration
          # before NVIDIA driver loads
          softdep nvidia pre: vfio-pci
        mode: '0644'
      when: nvidia_gpus | length > 0
      
    - name: Blacklist AMD drivers if AMD GPUs are for passthrough
      ansible.builtin.copy:
        dest: /etc/modprobe.d/blacklist-amdgpu.conf
        content: |
          blacklist amdgpu
          blacklist radeon
        mode: '0644'
      when: >
        amd_gpus | length > 0 and
        (single_gpu_passthrough or host_gpu_type != 'amd' or amd_gpus | length > 1)
      
    # Phase 6: Configure X.org to use the host GPU (for desktop systems)
    - name: Generate Xorg configuration
      ansible.builtin.template:
        src: templates/xorg.conf.j2
        dest: /etc/X11/xorg.conf
        mode: '0644'
      vars:
        xorg_driver: >-
          {% if host_gpu_type == 'nvidia' %}nvidia{% elif host_gpu_type == 'amd' %}amdgpu{% elif host_gpu_type == 'intel' %}intel{% endif %}
      when: >
        can_configure_passthrough and
        server_type is defined and
        server_type == 'desktop' and
        host_gpu is defined and
        host_gpu != ""
    
    - name: Skip X.org configuration for headless servers
      ansible.builtin.debug:
        msg: "Skipping X.org configuration for headless server {{ inventory_hostname }}"
      when: server_type is defined and server_type == 'headless'
    
    # Phase 7: Update system
    - name: Update initramfs
      ansible.builtin.command: update-initramfs -u
      when: grub_updated.changed | default(false)
    
    - name: Update GRUB
      ansible.builtin.command: update-grub
      when: grub_updated.changed | default(false)
    
    # Phase 8: Output useful debugging info
    - name: Save GPU information for later verification
      ansible.builtin.copy:
        dest: /var/tmp/gpu_passthrough_info.txt
        content: |
          # GPU Passthrough Configuration for {{ inventory_hostname }}
          # Generated on {{ ansible_date_time.date }} at {{ ansible_date_time.time }}
          
          ## All Detected GPUs
          {{ detected_gpus | join('\n') }}
          
          ## GPU Types
          NVIDIA: {{ nvidia_gpus | length }}
          AMD: {{ amd_gpus | length }}
          Intel: {{ intel_gpus | length }}
          
          ## Server Type
          {{ server_type | default('unknown') }}
          
          ## Single GPU Passthrough Mode
          {{ single_gpu_passthrough | default(false) }}
          
          {% if not single_gpu_passthrough | default(false) %}
          ## Host GPU
          {{ host_gpu | default('None specified') }}
          
          ## GPUs Reserved for Passthrough
          {% if passthrough_gpus is defined %}
          {% for gpu in passthrough_gpus %}
          {{ gpu }}
          {% endfor %}
          {% else %}
          None
          {% endif %}
          {% else %}
          ## All GPUs Reserved for Passthrough (Headless mode)
          {{ detected_gpus | join('\n') }}
          {% endif %}
          
          ## PCI IDs for VFIO
          {% if gpu_pci_ids is defined and gpu_pci_ids | length > 0 %}
          {{ gpu_pci_ids | join(', ') }}
          {% else %}
          None
          {% endif %}
          
          ## X.org Configuration
          {% if server_type is defined and server_type == 'desktop' %}
          Driver: {{ xorg_driver | default('Not specified') }}
          BusID: {{ xorg_busid | default('Not specified') }}
          {% else %}
          Not applicable (headless server)
          {% endif %}
        mode: '0644'
    
    # Phase 9: Display completion message
    - name: Display completion message
      ansible.builtin.debug:
        msg: >-
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% if can_configure_passthrough | bool and gpu_pci_ids is defined and gpu_pci_ids | length > 0 %}
          âœ… GPU Reservation Complete ({{ inventory_hostname }})
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          The system has been configured to reserve GPUs for future passthrough:
          - IOMMU is enabled with the {{ is_amd_cpu | ternary('AMD', 'Intel') }} IOMMU driver
          - {{ gpu_pci_ids | length }} GPUs have been reserved for passthrough
          - VFIO is configured for IDs: {{ gpu_pci_ids | join(', ') }}
          {% if single_gpu_passthrough | default(false) %}
          - All GPUs reserved for passthrough (headless server)
          {% else %}
          - Host will use the {{ host_gpu_type | upper }} GPU
          {% endif %}
          
          âš ï¸ IMPORTANT: A system reboot is required for changes to take effect.
          
          NEXT STEPS:
          1. Reboot the system: sudo reboot
          2. After reboot, verify with: 38_test_gpu_reservation.yaml
          3. Continue with other deployment playbooks
          
          {% elif single_gpu_passthrough | default(false) %}
          âœ… Single GPU Passthrough Configured ({{ inventory_hostname }})
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          The single NVIDIA GPU on headless server {{ inventory_hostname }} has been
          configured for passthrough:
          - IOMMU is enabled with the {{ is_amd_cpu | ternary('AMD', 'Intel') }} IOMMU driver
          - GPU will be bound to VFIO driver after reboot
          
          âš ï¸ IMPORTANT: A system reboot is required for changes to take effect.
          
          NEXT STEPS:
          1. Reboot the system: sudo reboot
          2. After reboot, verify with: 38_test_gpu_reservation.yaml
          3. Continue with other deployment playbooks
          
          {% else %}
          âš ï¸ GPU Reservation Skipped ({{ inventory_hostname }})
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          GPU passthrough configuration was skipped because only {{ total_gpus }} 
          GPU(s) were detected on a desktop system. At least 2 GPUs are required 
          for passthrough on desktop systems.
          
          The system configuration was not modified.
          
          NEXT STEPS:
          1. Continue with other deployment playbooks
          
          {% endif %}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•